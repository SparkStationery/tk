async function redeemCode() {
  const codeInput = document.getElementById("code-input").value.trim();

  if (codeInput.length !== 6) {
    messageBox.textContent = "Invalid code format. Please enter a 6-digit code.";
    messageBox.style.color = "red";
    return;
  }

  try {
    // 检查兑换码是否存在
    const codeRef = doc(db, "codes", codeInput);
    const codeDoc = await getDoc(codeRef);

    if (!codeDoc.exists()) {
      messageBox.textContent = "Invalid or expired code.";
      messageBox.style.color = "red";
      return;
    }

    const pointsToAdd = codeDoc.data().points; // 获取兑换码的分数

    // 获取当前用户数据
    const userRef = doc(db, "users", currentUser.uid);
    const userDoc = await getDoc(userRef);

    if (!userDoc.exists()) {
      messageBox.textContent = "User data not found!";
      messageBox.style.color = "red";
      return;
    }

    // ✅ **确保 rewardsPoint 是数字**
    const currentPoints = Number(userDoc.data().rewardsPoint) || 0; // 强制转换为数字
    const updatedPoints = currentPoints + pointsToAdd; // ✅ 正确加法

    // 更新 Firestore 用户数据
    await updateDoc(userRef, { rewardsPoint: updatedPoints });

    // 删除已使用的兑换码
    await deleteDoc(codeRef);

    messageBox.textContent = `Success! You earned ${pointsToAdd} points.`;
    messageBox.style.color = "green";

    // 更新 UI
    updatePointsDisplay();
  } catch (error) {
    console.error("Error redeeming code:", error);
    messageBox.textContent = "An error occurred. Please try again.";
    messageBox.style.color = "red";
  }
}
